name: Quark Auto Signin

on:
  schedule:
    - cron: "5 0 * * *"   # åŒ—äº¬æ—¶é—´ 08:05
  workflow_dispatch:

jobs:
  signin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Quark Signin
        env:
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          python << 'EOF'
          import requests, os, json, re

          raw_cookie = os.getenv("QUARK_COOKIE", "")
          tg_token = os.getenv("TG_BOT_TOKEN")
          tg_chat_id = os.getenv("TG_CHAT_ID")

          def tg_send(msg):
              if not tg_token or not tg_chat_id:
                  return
              url = f"https://api.telegram.org/bot{tg_token}/sendMessage"
              requests.post(url, data={
                  "chat_id": tg_chat_id,
                  "text": msg,
                  "parse_mode": "HTML"
              })

          if not raw_cookie:
              tg_send("âŒ <b>å¤¸å…‹ç­¾åˆ°å¤±è´¥</b>\næœªè®¾ç½® Cookie")
              raise Exception("QUARK_COOKIE not set")

          # è‡ªåŠ¨æ¸…æ´— Cookie
          cookie = raw_cookie.replace("\r", "").replace("\n", "").strip()
          cookie = re.sub(r"\s*;\s*", "; ", cookie)

          if not cookie or "=" not in cookie:
              raise Exception("Cookie æ¸…æ´—åä»ç„¶æ— æ•ˆ")

          headers = {
              "User-Agent": (
                  "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) "
                  "Chrome/120.0.0.0 Safari/537.36"
              ),
              "Cookie": cookie,
              "Referer": "https://pan.quark.cn/"
          }

          url = "https://drive-m.quark.cn/1/clouddrive/capacity/growth/info"

          try:
              r = requests.get(url, headers=headers, timeout=10)

              if r.status_code != 200:
                  raise Exception(f"HTTP {r.status_code}")

              try:
                  data = r.json()
              except json.JSONDecodeError:
                  raise Exception("è¿”å›é JSONï¼ŒCookie å¯èƒ½å·²å¤±æ•ˆ")

              if data.get("code") != 0 or not data.get("data"):
                  raise Exception("æ¥å£è¿”å›å¼‚å¸¸ï¼ŒCookie å¯èƒ½å·²å¤±æ•ˆ")

              sign_status = data["data"].get("signStatus")
              today_reward = data["data"].get("todayReward", {})

              if sign_status == 1:
                  msg = (
                      "âœ… <b>å¤¸å…‹ç½‘ç›˜ç­¾åˆ°æˆåŠŸ</b>\n"
                      f"ğŸ“¦ ä»Šæ—¥å¥–åŠ±ï¼š{today_reward.get('capacity', 0)} MB"
                  )
              else:
                  msg = "â„¹ï¸ <b>å¤¸å…‹ç½‘ç›˜ä»Šæ—¥å·²ç­¾åˆ°</b>"

              tg_send(msg)
              print(msg)

          except Exception as e:
              err = (
                  "ğŸš¨ <b>å¤¸å…‹ç­¾åˆ°å¼‚å¸¸</b>\n"
                  f"â— åŸå› ï¼š{e}\n\n"
                  "ğŸ‘‰ è¯·æ£€æŸ¥ Cookie æ˜¯å¦ä»ç„¶æœ‰æ•ˆ"
              )
              tg_send(err)
              raise
          EOF
